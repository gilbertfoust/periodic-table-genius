<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chemistry Learning Lab (Prototype)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2f;
      --panel2:#0e1730;
      --text:#e8eefc;
      --muted:#a8b3d6;
      --line:rgba(255,255,255,.10);
      --good:#66f0a6;
      --warn:#ffd27a;
      --bad:#ff7a7a;
      --chip:#142447;
      --shadow:0 18px 40px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 900px at 20% 10%, #152a5a 0%, var(--bg) 55%),
                  radial-gradient(900px 800px at 85% 25%, #1b3a77 0%, rgba(11,18,32,0) 60%),
                  var(--bg);
      color:var(--text);
    }

    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}

    header{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      margin-bottom:18px
    }

    .title{display:flex;flex-direction:column;gap:6px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;max-width:860px}

    .grid{
      display:grid;
      grid-template-columns: 1.35fr .9fr;
      gap:16px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .cardHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(16,26,47,.9), rgba(16,26,47,.6));
    }

    .cardHeader h2{margin:0;font-size:14px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}

    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .15s ease;
      display:inline-flex;gap:8px;align-items:center;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .pill[aria-pressed="true"]{background:rgba(102,240,166,.14);border-color:rgba(102,240,166,.35)}

    .input{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
      min-width:220px;
    }
    .input::placeholder{color:rgba(232,238,252,.55)}

    .content{padding:14px}

    /* Periodic table */
    .ptWrap{display:flex;flex-direction:column;gap:12px}
    .ptLegend{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

    /* Fix: allow horizontal scroll on small screens so group 18 (noble gases) is not clipped */
    .ptScroll{
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      padding-bottom:6px;
    }

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(20,36,71,.65);
      font-size:12px;
      color:var(--muted);
    }

    .dot{width:10px;height:10px;border-radius:50%}

    .pt{
      display:grid;
      grid-template-columns: repeat(18, minmax(34px, 1fr));
      gap:8px;
      width:100%;
      min-width:980px;
    }

    .fTitle{margin-top:10px;color:rgba(232,238,252,.85);font-size:12px;font-weight:700;letter-spacing:.2px}

    .fblock{
      display:grid;
      grid-template-columns: repeat(15, minmax(34px, 1fr));
      gap:8px;
      width:100%;
      min-width:820px;
      margin-top:8px;
    }

    .el{
      position:relative;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      min-height:58px;
      padding:8px 8px 6px;
      cursor:pointer;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      overflow:hidden;
    }

    .el:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22)}
    .el[data-selected="true"]{border-color:rgba(102,240,166,.55);box-shadow:0 0 0 3px rgba(102,240,166,.15) inset}

    .el.elMini{min-height:56px}

    .elNum{position:absolute;top:6px;left:8px;font-size:10px;color:rgba(232,238,252,.75)}
    .elSym{font-size:18px;font-weight:700;letter-spacing:.2px;margin-top:10px}
    .elName{font-size:10px;color:rgba(232,238,252,.70);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .overlayTag{
      position:absolute;right:8px;top:8px;
      font-size:10px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:rgba(232,238,252,.85);
      backdrop-filter: blur(6px);
    }

    /* Element detail */
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }

    .kv .box{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      padding:10px;
      min-height:54px;
    }

    .k{font-size:11px;color:rgba(232,238,252,.65);margin-bottom:6px}
    .v{font-size:13px;color:var(--text)}

    .bigEl{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.04);
      padding:12px;
    }

    .bigLeft{display:flex;gap:12px;align-items:center}
    .badge{
      width:56px;height:56px;border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:800
    }

    .bigMeta{display:flex;flex-direction:column;gap:4px}
    .bigName{font-size:14px;font-weight:700}
    .bigCat{font-size:12px;color:rgba(232,238,252,.72)}

    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}

    .panel{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12);border-radius:14px;padding:10px;margin-top:10px}

    .q{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    .qTitle{font-size:12px;color:rgba(232,238,252,.92);font-weight:700;margin-bottom:8px}
    .qOpts{display:flex;flex-direction:column;gap:8px}
    .opt{display:flex;gap:10px;align-items:flex-start;color:rgba(232,238,252,.88);font-size:12px}
    .opt input{margin-top:2px}
    .qFooter{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .msg{font-size:12px;color:rgba(232,238,252,.82)}

    /* Mixture lab */
    .labGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .labGrid{grid-template-columns:1fr}
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select, button{font:inherit;}

    select{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
      min-width:260px;
    }

    .num{
      width:140px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
    }

    .btn{
      background:linear-gradient(180deg, rgba(102,240,166,.22), rgba(102,240,166,.10));
      border:1px solid rgba(102,240,166,.45);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:transform .08s ease, filter .15s ease;
      font-size:13px;
      display:inline-flex;gap:10px;align-items:center;
    }

    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}

    .result{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.04);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .equation{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:rgba(232,238,252,.92)}

    .steps{display:flex;flex-direction:column;gap:8px}
    .step{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
      font-size:12px;
      color:rgba(232,238,252,.88);
      line-height:1.35;
    }

    .badge2{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }

    .viz{
      height:110px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(20,36,71,.7), rgba(16,26,47,.45));
      position:relative;
      overflow:hidden;
    }

    .viz .label{position:absolute;left:10px;top:10px;font-size:12px;color:rgba(232,238,252,.85)}

    .bubble{
      position:absolute;
      bottom:-20px;
      width:10px;
      height:10px;
      border-radius:50%;
      background:rgba(255,255,255,.75);
      animation: rise 2.4s linear infinite;
      opacity:.65;
    }

    @keyframes rise{
      from{transform:translateY(0) scale(.9)}
      to{transform:translateY(-150px) scale(1.15)}
    }

    .precip{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      height:0;
      background:rgba(255,255,255,.86);
      transition:height .6s ease;
    }

    .heat{
      position:absolute;
      inset:0;
      background:radial-gradient(240px 160px at 50% 60%, rgba(255,170,75,.0), rgba(255,170,75,.0));
      transition:background .6s ease;
    }

    .small{font-size:11px;color:rgba(232,238,252,.70)}

    footer{
      margin-top:16px;
      color:rgba(232,238,252,.62);
      font-size:12px;
      line-height:1.4;
    }

    :focus-visible{outline:2px solid rgba(102,240,166,.75);outline-offset:2px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Chemistry Learning Lab</h1>
        <div class="sub">
          Explore periodic patterns, inspect any element (1-118), and practice prediction with guided tutoring.
        </div>
      </div>
      <div class="row">
        <input id="search" class="input" placeholder="Search: H, Oxygen, 8, halogen, lanthanide" />
      </div>
    </header>

    <section class="grid">
      <div class="card" aria-label="Periodic table explorer">
        <div class="cardHeader">
          <h2>Periodic Table Explorer</h2>
          <div class="toolbar" role="toolbar" aria-label="Overlay toggles">
            <button class="pill" id="ovCategory" aria-pressed="true" title="Color by category">Category</button>
            <button class="pill" id="ovEN" aria-pressed="false" title="Color by electronegativity (where known)">Electronegativity</button>
            <button class="pill" id="ovAN" aria-pressed="false" title="Tag by atomic number">Atomic #</button>
            <button class="pill" id="ovGroup" aria-pressed="false" title="Tag by group">Group</button>
          </div>
        </div>

        <div class="content">
          <div class="ptWrap">
            <div class="ptLegend" id="legend"></div>

            <div class="ptScroll" aria-label="Scrollable periodic table">
              <div class="pt" id="ptable" aria-label="Periodic table grid"></div>
            </div>

            <div class="fTitle">Lanthanides (57-71)</div>
            <div class="ptScroll" aria-label="Scrollable lanthanides">
              <div class="fblock" id="fblockLn" aria-label="Lanthanides row"></div>
            </div>

            <div class="fTitle">Actinides (89-103)</div>
            <div class="ptScroll" aria-label="Scrollable actinides">
              <div class="fblock" id="fblockAn" aria-label="Actinides row"></div>
            </div>

            <div class="hint">
              Tip: on small screens, scroll the table left and right to reach group 18 (noble gases). Click any element to open its tutor.
            </div>
          </div>
        </div>
      </div>

      <div class="card" aria-label="Element details">
        <div class="cardHeader">
          <h2>Element Tutor</h2>
          <div class="toolbar">
            <span class="chip" id="selectedChip">No element selected</span>
          </div>
        </div>
        <div class="content">
          <div class="bigEl" id="bigEl">
            <div class="bigLeft">
              <div class="badge" id="badge">?</div>
              <div class="bigMeta">
                <div class="bigName" id="bigName">Select an element</div>
                <div class="bigCat" id="bigCat">Category, group, and period</div>
              </div>
            </div>
            <div class="badge2" id="trendBadge">Overlay: Category</div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="pill" id="tabBasics" aria-pressed="true">Basics</button>
            <button class="pill" id="tabTutor" aria-pressed="false">Tutor</button>
            <button class="pill" id="tabPractice" aria-pressed="false">Practice</button>
          </div>

          <div id="panelBasics">
            <div class="kv" id="kv"></div>
          </div>

          <div id="panelTutor" style="display:none">
            <div class="panel" id="tutorText"></div>
            <div class="panel" id="tutorElectro"></div>
            <div class="kv" id="tutorKv"></div>
          </div>

          <div id="panelPractice" style="display:none">
            <div class="hint">Practice focuses on what you can predict from position and category. Check answers to see feedback.</div>
            <div id="quiz"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px" aria-label="Mixture lab">
      <div class="cardHeader">
        <h2>Mixture Lab (Rule-Based Tutor)</h2>
        <div class="toolbar">
          <span class="chip">v1: curated reactions + stoichiometry</span>
        </div>
      </div>
      <div class="content">
        <div class="labGrid">
          <div>
            <div class="row" style="margin-bottom:10px">
              <select id="rxnSelect" aria-label="Choose a reaction"></select>
            </div>

            <div class="row" style="margin-bottom:10px">
              <span class="chip" id="r1Chip">Reactant A</span>
              <input class="num" id="r1M" type="number" min="0" step="0.01" placeholder="Molarity (M)" aria-label="Reactant A molarity" />
              <input class="num" id="r1V" type="number" min="0" step="0.1" placeholder="Volume (mL)" aria-label="Reactant A volume" />
            </div>

            <div class="row" style="margin-bottom:10px">
              <span class="chip" id="r2Chip">Reactant B</span>
              <input class="num" id="r2M" type="number" min="0" step="0.01" placeholder="Molarity (M)" aria-label="Reactant B molarity" />
              <input class="num" id="r2V" type="number" min="0" step="0.1" placeholder="Volume (mL)" aria-label="Reactant B volume" />
            </div>

            <div class="row" style="margin-top:8px">
              <button class="btn" id="runBtn">Run mixture</button>
              <button class="pill" id="exampleBtn" aria-pressed="false" title="Fill a working example for the selected reaction">Example values</button>
              <button class="pill" id="resetBtn" aria-pressed="false">Reset inputs</button>
              <button class="pill" id="runTestsBtn" aria-pressed="false" title="Run built-in sanity checks">Run tests</button>
            </div>

            <div class="hint" style="margin-top:10px">
              Inputs assume aqueous solutions. This version focuses on: acid-base neutralization, precipitation, gas formation, and a simple single-replacement redox case.
            </div>
          </div>

          <div>
            <div class="result" id="result">
              <div class="badge2" id="outcomeBadge">Choose a reaction and run the mixture.</div>
              <div class="equation" id="eqn">Equation will appear here.</div>

              <div class="viz" id="viz">
                <div class="label" id="vizLabel">Visual outcome</div>
                <div class="heat" id="heat"></div>
                <div class="precip" id="precip"></div>
              </div>

              <div class="steps" id="steps"></div>
              <div class="small" id="notes"></div>
              <div class="small" id="testStatus" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      Next extensions that would fit well: more overlays (atomic radius, ionization energy), more reaction families, and a lesson path that saves progress.
    </footer>
  </div>

  <script>
    // =============================
    // DATA: Periodic table (1-118)
    // Notes:
    // - This prototype prioritizes correct layout (group/period) and clear tutoring.
    // - Some advanced numeric properties (for example, electronegativity for every element) are left as null if not set.
    // =============================

    const ELEMENTS = [
      // Period 1
      {Z:1,  sym:"H",  name:"Hydrogen", group:1,  period:1, category:"nonmetal",     en:2.20},
      {Z:2,  sym:"He", name:"Helium",   group:18, period:1, category:"noble gas",    en:null},

      // Period 2
      {Z:3,  sym:"Li", name:"Lithium",  group:1,  period:2, category:"alkali metal", en:0.98},
      {Z:4,  sym:"Be", name:"Beryllium",group:2,  period:2, category:"alkaline earth",en:1.57},
      {Z:5,  sym:"B",  name:"Boron",    group:13, period:2, category:"metalloid",   en:2.04},
      {Z:6,  sym:"C",  name:"Carbon",   group:14, period:2, category:"nonmetal",    en:2.55},
      {Z:7,  sym:"N",  name:"Nitrogen", group:15, period:2, category:"nonmetal",    en:3.04},
      {Z:8,  sym:"O",  name:"Oxygen",   group:16, period:2, category:"nonmetal",    en:3.44},
      {Z:9,  sym:"F",  name:"Fluorine", group:17, period:2, category:"halogen",     en:3.98},
      {Z:10, sym:"Ne", name:"Neon",     group:18, period:2, category:"noble gas",   en:null},

      // Period 3
      {Z:11, sym:"Na", name:"Sodium",   group:1,  period:3, category:"alkali metal", en:0.93},
      {Z:12, sym:"Mg", name:"Magnesium",group:2,  period:3, category:"alkaline earth",en:1.31},
      {Z:13, sym:"Al", name:"Aluminum", group:13, period:3, category:"post-transition",en:1.61},
      {Z:14, sym:"Si", name:"Silicon",  group:14, period:3, category:"metalloid",   en:1.90},
      {Z:15, sym:"P",  name:"Phosphorus",group:15,period:3, category:"nonmetal",    en:2.19},
      {Z:16, sym:"S",  name:"Sulfur",   group:16, period:3, category:"nonmetal",    en:2.58},
      {Z:17, sym:"Cl", name:"Chlorine", group:17, period:3, category:"halogen",     en:3.16},
      {Z:18, sym:"Ar", name:"Argon",    group:18, period:3, category:"noble gas",   en:null},

      // Period 4
      {Z:19, sym:"K",  name:"Potassium", group:1,  period:4, category:"alkali metal", en:0.82},
      {Z:20, sym:"Ca", name:"Calcium",   group:2,  period:4, category:"alkaline earth",en:1.00},
      {Z:21, sym:"Sc", name:"Scandium",  group:3,  period:4, category:"transition metal",en:1.36},
      {Z:22, sym:"Ti", name:"Titanium",  group:4,  period:4, category:"transition metal",en:1.54},
      {Z:23, sym:"V",  name:"Vanadium",  group:5,  period:4, category:"transition metal",en:1.63},
      {Z:24, sym:"Cr", name:"Chromium",  group:6,  period:4, category:"transition metal",en:1.66},
      {Z:25, sym:"Mn", name:"Manganese", group:7,  period:4, category:"transition metal",en:1.55},
      {Z:26, sym:"Fe", name:"Iron",      group:8,  period:4, category:"transition metal",en:1.83},
      {Z:27, sym:"Co", name:"Cobalt",    group:9,  period:4, category:"transition metal",en:1.88},
      {Z:28, sym:"Ni", name:"Nickel",    group:10, period:4, category:"transition metal",en:1.91},
      {Z:29, sym:"Cu", name:"Copper",    group:11, period:4, category:"transition metal",en:1.90},
      {Z:30, sym:"Zn", name:"Zinc",      group:12, period:4, category:"transition metal",en:1.65},
      {Z:31, sym:"Ga", name:"Gallium",   group:13, period:4, category:"post-transition",en:1.81},
      {Z:32, sym:"Ge", name:"Germanium", group:14, period:4, category:"metalloid",   en:2.01},
      {Z:33, sym:"As", name:"Arsenic",   group:15, period:4, category:"metalloid",   en:2.18},
      {Z:34, sym:"Se", name:"Selenium",  group:16, period:4, category:"nonmetal",    en:2.55},
      {Z:35, sym:"Br", name:"Bromine",   group:17, period:4, category:"halogen",     en:2.96},
      {Z:36, sym:"Kr", name:"Krypton",   group:18, period:4, category:"noble gas",   en:3.00},

      // Period 5
      {Z:37, sym:"Rb", name:"Rubidium",  group:1,  period:5, category:"alkali metal", en:0.82},
      {Z:38, sym:"Sr", name:"Strontium", group:2,  period:5, category:"alkaline earth",en:0.95},
      {Z:39, sym:"Y",  name:"Yttrium",   group:3,  period:5, category:"transition metal",en:1.22},
      {Z:40, sym:"Zr", name:"Zirconium", group:4,  period:5, category:"transition metal",en:1.33},
      {Z:41, sym:"Nb", name:"Niobium",   group:5,  period:5, category:"transition metal",en:1.60},
      {Z:42, sym:"Mo", name:"Molybdenum",group:6,  period:5, category:"transition metal",en:2.16},
      {Z:43, sym:"Tc", name:"Technetium",group:7,  period:5, category:"transition metal",en:1.90},
      {Z:44, sym:"Ru", name:"Ruthenium", group:8,  period:5, category:"transition metal",en:2.20},
      {Z:45, sym:"Rh", name:"Rhodium",   group:9,  period:5, category:"transition metal",en:2.28},
      {Z:46, sym:"Pd", name:"Palladium", group:10, period:5, category:"transition metal",en:2.20},
      {Z:47, sym:"Ag", name:"Silver",    group:11, period:5, category:"transition metal",en:1.93},
      {Z:48, sym:"Cd", name:"Cadmium",   group:12, period:5, category:"transition metal",en:1.69},
      {Z:49, sym:"In", name:"Indium",    group:13, period:5, category:"post-transition",en:1.78},
      {Z:50, sym:"Sn", name:"Tin",       group:14, period:5, category:"post-transition",en:1.96},
      {Z:51, sym:"Sb", name:"Antimony",  group:15, period:5, category:"metalloid",   en:2.05},
      {Z:52, sym:"Te", name:"Tellurium", group:16, period:5, category:"metalloid",   en:2.10},
      {Z:53, sym:"I",  name:"Iodine",    group:17, period:5, category:"halogen",     en:2.66},
      {Z:54, sym:"Xe", name:"Xenon",     group:18, period:5, category:"noble gas",   en:2.60},

      // Period 6
      {Z:55, sym:"Cs", name:"Cesium",    group:1,  period:6, category:"alkali metal", en:0.79},
      {Z:56, sym:"Ba", name:"Barium",    group:2,  period:6, category:"alkaline earth",en:0.89},
      {Z:57, sym:"La", name:"Lanthanum", group:3,  period:6, category:"lanthanide",  en:1.10},
      // Lanthanides (f-block)
      {Z:58, sym:"Ce", name:"Cerium",     group:null, period:6, category:"lanthanide", en:1.12},
      {Z:59, sym:"Pr", name:"Praseodymium",group:null,period:6, category:"lanthanide", en:1.13},
      {Z:60, sym:"Nd", name:"Neodymium", group:null, period:6, category:"lanthanide", en:1.14},
      {Z:61, sym:"Pm", name:"Promethium",group:null, period:6, category:"lanthanide", en:1.13},
      {Z:62, sym:"Sm", name:"Samarium",  group:null, period:6, category:"lanthanide", en:1.17},
      {Z:63, sym:"Eu", name:"Europium",  group:null, period:6, category:"lanthanide", en:1.20},
      {Z:64, sym:"Gd", name:"Gadolinium",group:null, period:6, category:"lanthanide", en:1.20},
      {Z:65, sym:"Tb", name:"Terbium",   group:null, period:6, category:"lanthanide", en:1.20},
      {Z:66, sym:"Dy", name:"Dysprosium",group:null, period:6, category:"lanthanide", en:1.22},
      {Z:67, sym:"Ho", name:"Holmium",   group:null, period:6, category:"lanthanide", en:1.23},
      {Z:68, sym:"Er", name:"Erbium",    group:null, period:6, category:"lanthanide", en:1.24},
      {Z:69, sym:"Tm", name:"Thulium",   group:null, period:6, category:"lanthanide", en:1.25},
      {Z:70, sym:"Yb", name:"Ytterbium", group:null, period:6, category:"lanthanide", en:1.10},
      {Z:71, sym:"Lu", name:"Lutetium",  group:null, period:6, category:"lanthanide", en:1.27},
      {Z:72, sym:"Hf", name:"Hafnium",   group:4,  period:6, category:"transition metal",en:1.30},
      {Z:73, sym:"Ta", name:"Tantalum",  group:5,  period:6, category:"transition metal",en:1.50},
      {Z:74, sym:"W",  name:"Tungsten",  group:6,  period:6, category:"transition metal",en:2.36},
      {Z:75, sym:"Re", name:"Rhenium",   group:7,  period:6, category:"transition metal",en:1.90},
      {Z:76, sym:"Os", name:"Osmium",    group:8,  period:6, category:"transition metal",en:2.20},
      {Z:77, sym:"Ir", name:"Iridium",   group:9,  period:6, category:"transition metal",en:2.20},
      {Z:78, sym:"Pt", name:"Platinum",  group:10, period:6, category:"transition metal",en:2.28},
      {Z:79, sym:"Au", name:"Gold",      group:11, period:6, category:"transition metal",en:2.54},
      {Z:80, sym:"Hg", name:"Mercury",   group:12, period:6, category:"transition metal",en:2.00},
      {Z:81, sym:"Tl", name:"Thallium",  group:13, period:6, category:"post-transition",en:1.62},
      {Z:82, sym:"Pb", name:"Lead",      group:14, period:6, category:"post-transition",en:2.33},
      {Z:83, sym:"Bi", name:"Bismuth",   group:15, period:6, category:"post-transition",en:2.02},
      {Z:84, sym:"Po", name:"Polonium",  group:16, period:6, category:"post-transition",en:2.00},
      {Z:85, sym:"At", name:"Astatine",  group:17, period:6, category:"halogen",     en:2.20},
      {Z:86, sym:"Rn", name:"Radon",     group:18, period:6, category:"noble gas",   en:null},

      // Period 7
      {Z:87, sym:"Fr", name:"Francium",  group:1,  period:7, category:"alkali metal", en:0.70},
      {Z:88, sym:"Ra", name:"Radium",    group:2,  period:7, category:"alkaline earth",en:0.90},
      {Z:89, sym:"Ac", name:"Actinium",  group:3,  period:7, category:"actinide",    en:1.10},
      // Actinides (f-block)
      {Z:90, sym:"Th", name:"Thorium",   group:null, period:7, category:"actinide",   en:1.30},
      {Z:91, sym:"Pa", name:"Protactinium",group:null,period:7,category:"actinide",  en:1.50},
      {Z:92, sym:"U",  name:"Uranium",   group:null, period:7, category:"actinide",   en:1.38},
      {Z:93, sym:"Np", name:"Neptunium", group:null, period:7, category:"actinide",   en:1.36},
      {Z:94, sym:"Pu", name:"Plutonium", group:null, period:7, category:"actinide",   en:1.28},
      {Z:95, sym:"Am", name:"Americium", group:null, period:7, category:"actinide",   en:1.13},
      {Z:96, sym:"Cm", name:"Curium",    group:null, period:7, category:"actinide",   en:1.28},
      {Z:97, sym:"Bk", name:"Berkelium", group:null, period:7, category:"actinide",   en:1.30},
      {Z:98, sym:"Cf", name:"Californium",group:null,period:7, category:"actinide",   en:1.30},
      {Z:99, sym:"Es", name:"Einsteinium",group:null,period:7, category:"actinide",   en:1.30},
      {Z:100,sym:"Fm", name:"Fermium",   group:null, period:7, category:"actinide",   en:1.30},
      {Z:101,sym:"Md", name:"Mendelevium",group:null,period:7, category:"actinide",   en:1.30},
      {Z:102,sym:"No", name:"Nobelium",  group:null, period:7, category:"actinide",   en:1.30},
      {Z:103,sym:"Lr", name:"Lawrencium",group:null, period:7, category:"actinide",   en:1.30},
      {Z:104,sym:"Rf", name:"Rutherfordium",group:4,period:7,category:"transition metal",en:null},
      {Z:105,sym:"Db", name:"Dubnium",   group:5,  period:7, category:"transition metal",en:null},
      {Z:106,sym:"Sg", name:"Seaborgium",group:6,  period:7, category:"transition metal",en:null},
      {Z:107,sym:"Bh", name:"Bohrium",   group:7,  period:7, category:"transition metal",en:null},
      {Z:108,sym:"Hs", name:"Hassium",   group:8,  period:7, category:"transition metal",en:null},
      {Z:109,sym:"Mt", name:"Meitnerium",group:9,  period:7, category:"transition metal",en:null},
      {Z:110,sym:"Ds", name:"Darmstadtium",group:10,period:7,category:"transition metal",en:null},
      {Z:111,sym:"Rg", name:"Roentgenium",group:11,period:7,category:"transition metal",en:null},
      {Z:112,sym:"Cn", name:"Copernicium",group:12,period:7,category:"transition metal",en:null},
      {Z:113,sym:"Nh", name:"Nihonium",  group:13, period:7, category:"post-transition",en:null},
      {Z:114,sym:"Fl", name:"Flerovium", group:14, period:7, category:"post-transition",en:null},
      {Z:115,sym:"Mc", name:"Moscovium", group:15, period:7, category:"post-transition",en:null},
      {Z:116,sym:"Lv", name:"Livermorium",group:16, period:7, category:"post-transition",en:null},
      {Z:117,sym:"Ts", name:"Tennessine",group:17, period:7, category:"halogen",     en:null},
      {Z:118,sym:"Og", name:"Oganesson", group:18, period:7, category:"noble gas",   en:null},
    ];

    const CATEGORY_COLORS = {
      "alkali metal": "#ff7a7a",
      "alkaline earth": "#ffd27a",
      "transition metal": "#7aa7ff",
      "post-transition": "#7affc9",
      "metalloid": "#b792ff",
      "nonmetal": "#66f0a6",
      "halogen": "#ff7ad6",
      "noble gas": "#7ad1ff",
      "lanthanide": "#ffa7f2",
      "actinide": "#ffb68a",
    };

    const ELEMENT_BY_Z = new Map(ELEMENTS.map(e => [e.Z, e]));

    // =============================
    // DATA: Curated reaction library
    // =============================

    const REACTIONS = [
      {
        id:"neutralization",
        label:"HCl(aq) + NaOH(aq)  →  NaCl(aq) + H2O(l)",
        type:"Acid-base neutralization",
        A:{name:"HCl", display:"Hydrochloric acid (HCl)", coeff:1, mode:'solution'},
        B:{name:"NaOH", display:"Sodium hydroxide (NaOH)", coeff:1, mode:'solution'},
        products:["NaCl(aq)", "H2O(l)"],
        prodCoeffs:{"NaCl(aq)":1, "H2O(l)":1},
        balanced:"1 HCl(aq) + 1 NaOH(aq) → 1 NaCl(aq) + 1 H2O(l)",
        visuals:{kind:"heat", message:"Temperature rises (typical for strong acid + strong base).", heat:"exo"},
        notes:"Driving idea: proton transfer. H+ combines with OH- to make water, and spectator ions remain in solution."
      },
      {
        id:"precip_agcl",
        label:"AgNO3(aq) + NaCl(aq)  →  AgCl(s) + NaNO3(aq)",
        type:"Precipitation (double replacement)",
        A:{name:"AgNO3", display:"Silver nitrate (AgNO3)", coeff:1, mode:'solution'},
        B:{name:"NaCl", display:"Sodium chloride (NaCl)", coeff:1, mode:'solution'},
        products:["AgCl(s)", "NaNO3(aq)"],
        prodCoeffs:{"AgCl(s)":1, "NaNO3(aq)":1},
        balanced:"1 AgNO3(aq) + 1 NaCl(aq) → 1 AgCl(s) + 1 NaNO3(aq)",
        visuals:{kind:"precip", message:"White precipitate forms (AgCl).", precipColor:"white"},
        notes:"The solid forms because Ag+ and Cl- build a low-solubility lattice. Many chlorides dissolve, but AgCl is a common insoluble exception."
      },
      {
        id:"gas_co2",
        label:"HCl(aq) + NaHCO3(aq)  →  CO2(g) + H2O(l) + NaCl(aq)",
        type:"Gas formation (acid + bicarbonate)",
        A:{name:"HCl", display:"Hydrochloric acid (HCl)", coeff:1, mode:'solution'},
        B:{name:"NaHCO3", display:"Sodium bicarbonate (NaHCO3)", coeff:1, mode:'solution'},
        products:["CO2(g)", "H2O(l)", "NaCl(aq)"],
        prodCoeffs:{"CO2(g)":1, "H2O(l)":1, "NaCl(aq)":1},
        balanced:"1 HCl(aq) + 1 NaHCO3(aq) → 1 CO2(g) + 1 H2O(l) + 1 NaCl(aq)",
        visuals:{kind:"gas", message:"Gas bubbles form (CO2)."},
        notes:"CO2 escapes as a gas, which pulls the reaction forward. The acid supplies H+; bicarbonate supplies CO3/HCO3 chemistry."
      },
      {
        id:"precip_cuoh2",
        label:"CuSO4(aq) + 2 NaOH(aq)  →  Cu(OH)2(s) + Na2SO4(aq)",
        type:"Precipitation (metal hydroxide)",
        A:{name:"CuSO4", display:"Copper(II) sulfate (CuSO4)", coeff:1, mode:'solution'},
        B:{name:"NaOH", display:"Sodium hydroxide (NaOH)", coeff:2, mode:'solution'},
        products:["Cu(OH)2(s)", "Na2SO4(aq)"],
        prodCoeffs:{"Cu(OH)2(s)":1, "Na2SO4(aq)":1},
        balanced:"1 CuSO4(aq) + 2 NaOH(aq) → 1 Cu(OH)2(s) + 1 Na2SO4(aq)",
        visuals:{kind:"precip", message:"Blue precipitate forms (Cu(OH)2).", precipColor:"blue"},
        notes:"Many metal hydroxides are poorly soluble. When Cu2+ meets enough OH-, the solid forms."
      },
      {
        id:"single_replacement",
        label:"Fe + CuSO4(aq)  →  FeSO4(aq) + Cu",
        type:"Single replacement (redox, simplified)",
        A:{name:"Fe", display:"Iron (Fe)", coeff:1, mode:'moles'},
        B:{name:"CuSO4", display:"Copper(II) sulfate (CuSO4)", coeff:1, mode:'solution'},
        products:["FeSO4(aq)", "Cu"],
        prodCoeffs:{"FeSO4(aq)":1, "Cu":1},
        balanced:"1 Fe + 1 CuSO4(aq) → 1 FeSO4(aq) + 1 Cu",
        visuals:{kind:"color", message:"Copper deposits; blue solution fades toward green.", colorShift:"blueToGreen"},
        notes:"Conceptually, Fe can donate electrons to Cu2+. This version is presented as a stoichiometry-and-classification exercise."
      }
    ];

    // =============================
    // UI STATE
    // =============================
    const state = {
      selectedZ: null,
      overlay: "category", // category | en | an | group
      search: "",
      detailTab: "basics", // basics | tutor | practice
    };

    // =============================
    // HELPERS
    // =============================
    function clamp(x, a, b){return Math.max(a, Math.min(b, x));}

    function normalize(value, min, max){
      if(value === null || value === undefined) return null;
      if(max === min) return 0.5;
      return clamp((value - min) / (max - min), 0, 1);
    }

    function hslFromT(t){
      // A gentle hue sweep: 190 (blue) -> 30 (orange)
      const hue = 190 + (30 - 190) * t;
      const sat = 70;
      const lit = 42 + 12 * (1 - Math.abs(t - 0.5) * 2);
      return `hsl(${hue.toFixed(0)} ${sat}% ${lit.toFixed(0)}%)`;
    }

    function byZ(Z){return ELEMENT_BY_Z.get(Z) || null;}

    function findElement(query){
      const q = String(query || "").trim().toLowerCase();
      if(!q) return null;

      const asNum = Number(q);
      if(Number.isFinite(asNum) && asNum > 0) return byZ(asNum) || null;

      // category lookup
      const catMatch = Object.keys(CATEGORY_COLORS).find(c => c.toLowerCase().includes(q));
      if(catMatch) return {__categoryFocus: catMatch};

      return ELEMENTS.find(e =>
        e.sym.toLowerCase() === q ||
        e.name.toLowerCase().includes(q)
      ) || null;
    }

    function safeGroupLabel(e){
      if(e.group === null || e.group === undefined) return 'f-block';
      return String(e.group);
    }

    function valenceElectrons(e){
      if(!e || e.group === null || e.group === undefined) return null;
      const g = e.group;
      if(g === 1) return 1;
      if(g === 2) return 2;
      if(g >= 13 && g <= 18) return g - 10;
      return null;
    }

    function typicalIon(e){
      if(!e || e.group === null || e.group === undefined) return null;
      const g = e.group;
      if(g === 1) return '+1';
      if(g === 2) return '+2';
      if(g === 13) return '+3';
      if(g === 15) return '-3';
      if(g === 16) return '-2';
      if(g === 17) return '-1';
      if(g === 18) return '0';
      // Transition metals and many p-block metals vary.
      return null;
    }

    function groupProfile(e){
      if(!e) return {label:'', meaning:''};
      const g = e.group;

      if(g === 1) return {
        label: 'Group 1 (alkali metals) + Hydrogen as a special case',
        meaning: 'Main idea: one valence electron. These elements tend to lose one electron in many reactions, forming +1 ions. Many reactions are driven by electrostatic attraction between cations and anions.'
      };
      if(g === 2) return {
        label: 'Group 2 (alkaline earth metals)',
        meaning: 'Main idea: two valence electrons. These elements often form +2 ions. Their compounds can be ionic, and many hydroxides/oxides are basic.'
      };
      if(g === 13) return {
        label: 'Group 13 (boron group)',
        meaning: 'Main idea: about three valence electrons in the main-group rule. Behavior varies across the group: boron is more covalent, while heavier members are more metallic and can show multiple oxidation states.'
      };
      if(g === 14) return {
        label: 'Group 14 (carbon group)',
        meaning: 'Main idea: about four valence electrons. Bonding ranges from strongly covalent (C, Si) to more metallic behavior in heavier members. Oxidation states can vary.'
      };
      if(g === 15) return {
        label: 'Group 15 (pnictogens)',
        meaning: 'Main idea: about five valence electrons. Many members form covalent bonds, and some can form -3 ions in simple ionic models. Oxidation states can vary widely in practice.'
      };
      if(g === 16) return {
        label: 'Group 16 (chalcogens)',
        meaning: 'Main idea: about six valence electrons. Many members form -2 ions in simple ionic models, or covalent bonds in molecular compounds. Oxygen is unusually electronegative and often forms polar bonds.'
      };
      if(g === 17) return {
        label: 'Group 17 (halogens)',
        meaning: 'Main idea: about seven valence electrons. Many halogens tend to gain one electron in simple ionic models, forming -1 ions. They also form polar covalent bonds depending on partners.'
      };
      if(g === 18) return {
        label: 'Group 18 (noble gases)',
        meaning: 'Main idea: filled valence shells in many cases. They tend to be less reactive under many conditions. Some heavier noble gases form compounds under specific circumstances.'
      };
      if(g !== null && g !== undefined && g >= 3 && g <= 12) return {
        label: 'Groups 3-12 (transition metals)',
        meaning: 'Main idea: d-electrons can participate in bonding. Multiple oxidation states are common, so bonding and reactivity can vary by context.'
      };

      return {label:'f-block', meaning:'Main idea: f-electrons contribute to chemistry. Lanthanides are often +3; actinides include many radioactive elements and show varied oxidation states.'};
    }

    function categoryProfile(cat){
      const c = String(cat || '').toLowerCase();
      if(c === 'alkali metal') return 'Reactive metals with one valence electron. In many reactions they form +1 ions and make ionic salts with many nonmetals.';
      if(c === 'alkaline earth') return 'Metals that often form +2 ions. Many of their oxides and hydroxides are basic.';
      if(c === 'transition metal') return 'Metals where d-electrons allow multiple oxidation states. This supports varied bonding, colored compounds, and catalytic behavior in some systems.';
      if(c === 'post-transition') return 'p-block metals. Many are softer and more polarizable than transition metals, and oxidation states can vary.';
      if(c === 'metalloid') return 'Boundary behavior: can show both metallic and nonmetallic traits, often important in semiconductors.';
      if(c === 'nonmetal') return 'Often forms covalent bonds. Many nonmetals have higher electronegativity and can attract bonding electrons strongly.';
      if(c === 'halogen') return 'Highly electronegative group 17 nonmetals. Often forms -1 ions in simple ionic models, or polar covalent bonds.';
      if(c === 'noble gas') return 'Filled-shell elements that are often unreactive under many conditions. Heavier members can form compounds in specific cases.';
      if(c === 'lanthanide') return 'f-block metals often associated with +3 ions and magnetic/optical applications.';
      if(c === 'actinide') return 'f-block elements including many radioactive members; oxidation states can vary and chemistry can be complex.';
      return 'A category groups elements with related electron structures, which tends to shape bonding patterns and typical reactions.';
    }

    function interactionLens(e){
      const parts = [];
      const en = (typeof e.en === 'number') ? e.en : null;

      parts.push('Chemical interaction is often governed by electrostatic attraction between positive and negative charge, and by how strongly atoms hold or share electrons.');

      if(en !== null){
        parts.push(`This element has electronegativity ${en}. Higher electronegativity usually means stronger attraction for shared electrons, which can increase bond polarity.`);
      } else {
        parts.push('Electronegativity is not listed here for this element, but you can still reason from category and position (metals often donate electrons; many nonmetals attract them).');
      }

      parts.push('Ionization energy relates to how difficult it is to remove an electron; electron affinity relates to the tendency to gain one. Both are connected to effective nuclear charge and shielding, which vary across the table.');
      parts.push('Polarizability (how easily an electron cloud distorts) tends to increase for larger, heavier atoms. This can influence bond character and intermolecular forces.');

      return parts;
    }

    function positionStory(e){
      const g = e.group;
      const p = e.period;

      const shell = (p ? `period ${p} suggests the valence shell is n=${p}` : '');
      const groupPart = (g ? `group ${g}` : 'the f-block');

      let blockHint = '';
      if(e.category === 'alkali metal') blockHint = 'These are typically reactive metals with one valence electron.';
      else if(e.category === 'alkaline earth') blockHint = 'These often form +2 ions and make basic oxides/hydroxides.';
      else if(e.category === 'halogen') blockHint = 'These often gain one electron in simple ionic models.';
      else if(e.category === 'noble gas') blockHint = 'These often have filled valence shells, so they tend to be less reactive under many conditions.';
      else if(e.category === 'nonmetal') blockHint = 'Nonmetals often form covalent bonds, and many have higher electronegativity.';
      else if(e.category === 'metalloid') blockHint = 'Metalloids sit at the boundary and can show mixed behavior.';
      else if(e.category === 'post-transition') blockHint = 'Many p-block metals show multiple oxidation states and increased polarizability.';
      else if(e.category === 'transition metal') blockHint = 'Transition metals often have multiple oxidation states because d-electrons can participate in bonding.';
      else if(e.category === 'lanthanide') blockHint = 'Lanthanides are often +3 and involve f-electrons; many are used in magnets and optical materials.';
      else if(e.category === 'actinide') blockHint = 'Actinides include many radioactive elements; oxidation states can vary and f-electrons matter.';

      const ve = valenceElectrons(e);
      const ion = typicalIon(e);

      const vePart = (ve !== null) ? `From the group rule, you would predict about ${ve} valence electron${ve===1?'':'s'}.` : 'Valence electrons are not read off by a single main-group rule here.';
      const ionPart = (ion !== null) ? `A common simple ion is ${ion}.` : 'A single “default ion” is not reliable here; context matters.';

      const gp = groupProfile(e);

      return {
        summary: `${e.name} sits in ${groupPart} and ${shell}. ${blockHint}`,
        predict: `${vePart} ${ionPart}`,
        groupLabel: gp.label,
        groupMeaning: gp.meaning,
        categoryMeaning: categoryProfile(e.category),
        trends: `Across a period, electronegativity and ionization energy often rise, while atomic radius often falls. Down a group, the opposite pattern often appears because additional shells increase size and shielding.`,
        interactions: interactionLens(e)
      };
    }

    // =============================
    // RENDER: Legend
    // =============================
    function renderLegend(){
      const legend = document.getElementById('legend');
      legend.innerHTML = "";

      if(state.overlay === 'category'){
        const cats = [
          "alkali metal","alkaline earth","transition metal","post-transition",
          "metalloid","nonmetal","halogen","noble gas","lanthanide","actinide"
        ];
        cats.forEach(cat => {
          const el = document.createElement('div');
          el.className = 'chip';
          el.innerHTML = `<span class="dot" style="background:${CATEGORY_COLORS[cat] || '#9aa6c8'}"></span><span>${cat}</span>`;
          legend.appendChild(el);
        });
      } else if(state.overlay === 'en'){
        const el = document.createElement('div');
        el.className = 'chip';
        el.textContent = 'Overlay: electronegativity (color shows relative values where known; unknown values are neutral)';
        legend.appendChild(el);
      } else if(state.overlay === 'an'){
        const el = document.createElement('div');
        el.className = 'chip';
        el.textContent = 'Overlay: atomic number shown as tag';
        legend.appendChild(el);
      } else if(state.overlay === 'group'){
        const el = document.createElement('div');
        el.className = 'chip';
        el.textContent = 'Overlay: group shown as tag (f-block shows as “f”)';
        legend.appendChild(el);
      }
    }

    // =============================
    // RENDER: Periodic table (main block)
    // =============================
    function renderPT(){
      const root = document.getElementById('ptable');
      root.innerHTML = "";

      const enValues = ELEMENTS.map(e => e.en).filter(v => typeof v === 'number');
      const enMin = enValues.length ? Math.min(...enValues) : 0;
      const enMax = enValues.length ? Math.max(...enValues) : 1;

      // Build lookup by (period, group) for elements with a defined group
      const pos = new Map();
      ELEMENTS.forEach(e => {
        if(e.group !== null && e.group !== undefined && e.period !== null && e.period !== undefined){
          pos.set(`${e.period}:${e.group}`, e);
        }
      });

      // Determine whether we are focusing a category search
      const searchHit = findElement(state.search);
      const categoryFocus = searchHit && searchHit.__categoryFocus ? searchHit.__categoryFocus : null;

      for(let period = 1; period <= 7; period++){
        for(let group = 1; group <= 18; group++){
          const e = pos.get(`${period}:${group}`);
          if(!e){
            const cell = document.createElement('div');
            cell.style.minHeight = '58px';
            cell.style.borderRadius = '14px';
            cell.style.border = '1px dashed rgba(255,255,255,.08)';
            cell.style.background = 'rgba(255,255,255,.02)';
            root.appendChild(cell);
            continue;
          }
          root.appendChild(renderElementCell(e, {enMin, enMax}));
        }
      }

      // Apply search dimming after cells exist (works for both main and f-block)
      applySearchDimming(categoryFocus);
    }

    function renderFBlocks(){
      const lnRoot = document.getElementById('fblockLn');
      const anRoot = document.getElementById('fblockAn');
      lnRoot.innerHTML = "";
      anRoot.innerHTML = "";

      const enValues = ELEMENTS.map(e => e.en).filter(v => typeof v === 'number');
      const enMin = enValues.length ? Math.min(...enValues) : 0;
      const enMax = enValues.length ? Math.max(...enValues) : 1;

      const lanthanides = ELEMENTS.filter(e => e.category === 'lanthanide' && e.Z >= 57 && e.Z <= 71).sort((a,b)=>a.Z-b.Z);
      const actinides  = ELEMENTS.filter(e => e.category === 'actinide' && e.Z >= 89 && e.Z <= 103).sort((a,b)=>a.Z-b.Z);

      lanthanides.forEach(e => lnRoot.appendChild(renderElementCell(e, {enMin, enMax, mini:true})));
      actinides.forEach(e => anRoot.appendChild(renderElementCell(e, {enMin, enMax, mini:true})));

      const searchHit = findElement(state.search);
      const categoryFocus = searchHit && searchHit.__categoryFocus ? searchHit.__categoryFocus : null;
      applySearchDimming(categoryFocus);
    }

    function renderElementCell(e, {enMin, enMax, mini=false}={}){
      const cell = document.createElement('div');
      cell.className = mini ? 'el elMini' : 'el';
      cell.tabIndex = 0;
      cell.setAttribute('role','button');
      cell.setAttribute('aria-label', `${e.name} (${e.sym})`);
      cell.dataset.z = String(e.Z);
      cell.dataset.selected = String(state.selectedZ === e.Z);

      // Overlay color
      if(state.overlay === 'category'){
        const col = CATEGORY_COLORS[e.category] || '#9aa6c8';
        cell.style.background = `linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), linear-gradient(180deg, ${col}40, ${col}12)`;
      } else if(state.overlay === 'en'){
        if(typeof e.en === 'number'){
          const t = normalize(e.en, enMin, enMax);
          const col = hslFromT(t);
          cell.style.background = `linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), linear-gradient(180deg, ${col}55, ${col}18)`;
        } else {
          cell.style.background = `rgba(255,255,255,.04)`;
        }
      } else {
        cell.style.background = `rgba(255,255,255,.04)`;
      }

      // Overlay tag
      const tag = document.createElement('div');
      tag.className = 'overlayTag';
      tag.style.display = 'none';
      if(state.overlay === 'an'){
        tag.style.display = 'inline-flex';
        tag.textContent = `#${e.Z}`;
      }
      if(state.overlay === 'group'){
        tag.style.display = 'inline-flex';
        tag.textContent = (e.group === null || e.group === undefined) ? 'f' : `G${e.group}`;
      }

      cell.innerHTML = `
        <div class="elNum">${e.Z}</div>
        <div class="elSym">${e.sym}</div>
        <div class="elName" title="${e.name}">${e.name}</div>
      `;
      cell.appendChild(tag);

      cell.addEventListener('click', () => selectElement(e.Z));
      cell.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter' || ev.key === ' '){
          ev.preventDefault();
          selectElement(e.Z);
        }
      });

      return cell;
    }

    function applySearchDimming(categoryFocus){
      const q = state.search.trim().toLowerCase();
      const allCells = [...document.querySelectorAll('.el')];
      if(!q){
        allCells.forEach(c => c.style.opacity = '1');
        return;
      }

      allCells.forEach(c => {
        const z = Number(c.dataset.z);
        const e = byZ(z);
        if(!e){ c.style.opacity = '1'; return; }

        let dim = false;
        if(categoryFocus){
          dim = e.category !== categoryFocus;
        } else {
          const isMatch = (
            e.sym.toLowerCase().includes(q) ||
            e.name.toLowerCase().includes(q) ||
            String(e.Z) === q
          );
          dim = !isMatch;
        }
        c.style.opacity = dim ? '0.35' : '1';
      });
    }

    // =============================
    // DETAIL TAB
    // =============================
    function setDetailTab(tab){
      state.detailTab = tab;
      document.getElementById('tabBasics').setAttribute('aria-pressed', String(tab === 'basics'));
      document.getElementById('tabTutor').setAttribute('aria-pressed', String(tab === 'tutor'));
      document.getElementById('tabPractice').setAttribute('aria-pressed', String(tab === 'practice'));

      document.getElementById('panelBasics').style.display = (tab === 'basics') ? '' : 'none';
      document.getElementById('panelTutor').style.display = (tab === 'tutor') ? '' : 'none';
      document.getElementById('panelPractice').style.display = (tab === 'practice') ? '' : 'none';

      renderDetail();
    }

    // =============================
    // RENDER: Element detail + tutoring
    // =============================
    function renderDetail(){
      const chip = document.getElementById('selectedChip');
      const badge = document.getElementById('badge');
      const bigName = document.getElementById('bigName');
      const bigCat = document.getElementById('bigCat');
      const kv = document.getElementById('kv');
      const trendBadge = document.getElementById('trendBadge');

      const e = state.selectedZ ? byZ(state.selectedZ) : null;

      const overlayName = state.overlay === 'category' ? 'Category'
        : state.overlay === 'en' ? 'Electronegativity'
        : state.overlay === 'an' ? 'Atomic number'
        : 'Group';
      trendBadge.textContent = `Overlay: ${overlayName}`;

      if(!e){
        chip.textContent = 'No element selected';
        badge.textContent = '?';
        bigName.textContent = 'Select an element';
        bigCat.textContent = 'Category, group, and period';
        kv.innerHTML = '';
        document.getElementById('tutorText').textContent = '';
        document.getElementById('tutorElectro').textContent = '';
        document.getElementById('tutorKv').innerHTML = '';
        document.getElementById('quiz').innerHTML = '';
        return;
      }

      chip.textContent = `${e.sym} · ${e.name}`;
      badge.textContent = e.sym;
      bigName.textContent = `${e.name} (Z=${e.Z})`;
      bigCat.textContent = `${e.category} · group ${safeGroupLabel(e)} · period ${e.period}`;

      // Basics
      const ve = valenceElectrons(e);
      const ion = typicalIon(e);
      const rows = [
        {k:'Atomic number', v:String(e.Z)},
        {k:'Symbol', v:e.sym},
        {k:'Category', v:e.category},
        {k:'Period', v:String(e.period)},
        {k:'Group', v:safeGroupLabel(e)},
        {k:'Valence electrons (rule)', v:(ve === null ? 'n/a' : String(ve))},
        {k:'Typical simple ion', v:(ion === null ? 'n/a' : ion)},
        {k:'Electronegativity', v:(typeof e.en === 'number' ? String(e.en) : 'n/a')},
      ];

      kv.innerHTML = rows.map(r => `
        <div class="box">
          <div class="k">${r.k}</div>
          <div class="v">${r.v}</div>
        </div>
      `).join('');

      // Tutor
      const story = positionStory(e);
      const tutorText = document.getElementById('tutorText');
      tutorText.innerHTML = `
        <div style="font-weight:700;color:rgba(232,238,252,.92);margin-bottom:6px">How to read this element from the table</div>
        <div style="color:rgba(232,238,252,.88);font-size:12px;line-height:1.45">
          <div style="margin-bottom:10px">${story.summary}</div>

          <div style="margin-bottom:10px"><strong>Group meaning:</strong> ${story.groupLabel}. ${story.groupMeaning}</div>
          <div style="margin-bottom:10px"><strong>Category meaning:</strong> ${story.categoryMeaning}</div>

          <div style="margin-bottom:10px"><strong>What you can predict quickly:</strong> ${story.predict}</div>

          <div><strong>Trend lens:</strong> ${story.trends}</div>
        </div>
      `;

      const tutorElectro = document.getElementById('tutorElectro');
      tutorElectro.innerHTML = `
        <div style="font-weight:700;color:rgba(232,238,252,.92);margin-bottom:6px">Electromagnetic and electron-structure lens</div>
        <div style="color:rgba(232,238,252,.88);font-size:12px;line-height:1.45">
          ${story.interactions.map(line => `<div style="margin-bottom:8px">${line}</div>`).join('')}
          <div style="margin-top:10px;color:rgba(232,238,252,.78)">If you compare this element with neighbors in the same group and period, you can often explain reactivity differences by changes in size (distance), shielding, and effective nuclear charge (attraction).</div>
        </div>
      `;

      const tutorKv = document.getElementById('tutorKv');
      tutorKv.innerHTML = [
        {k:'If you move right in the same period…', v:'effective nuclear charge tends to increase, while atomic radius tends to decrease. Many elements hold electrons more tightly.'},
        {k:'If you move down the same group…', v:'additional shells increase size and shielding; outer electrons can be held less tightly.'},
        {k:'Bond-type cue', v:'Large electronegativity difference tends to increase ionic character; similar electronegativity tends to increase covalent character.'},
        {k:'Charge cue', v:'Ions attract by electrostatic force; higher charge and smaller size can increase lattice strength in many salts.'},
        {k:'Polarizability cue', v:'Larger atoms tend to be more polarizable, which can influence bond character and intermolecular attractions.'},
      ].map(r => `
        <div class="box">
          <div class="k">${r.k}</div>
          <div class="v">${r.v}</div>
        </div>
      `).join('');

      // Practice
      renderQuiz(e);
    }

    function renderQuiz(e){
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = '';

      const ve = valenceElectrons(e);
      const ion = typicalIon(e);

      const qs = [];
      if(ve !== null){
        qs.push({
          id:'q_ve',
          title:'How many valence electrons would you predict from the group rule?',
          options:['1','2','3','4','5','6','7','8'],
          answer:String(ve),
          explain:'Main-group rule: groups 1-2 map to 1-2; groups 13-18 map to 3-8.'
        });
      }

      if(ion !== null){
        qs.push({
          id:'q_ion',
          title:'What is a common simple ion charge to expect first?',
          options:['-3','-2','-1','0','+1','+2','+3'],
          answer:ion,
          explain:'This is a first-pass heuristic: group 1 → +1, group 2 → +2, group 17 → -1, group 16 → -2, group 15 → -3, group 18 → 0, group 13 → +3.'
        });
      }

      // A trend question that avoids numeric values
      if(e.group !== null && e.group !== undefined && e.group !== 1){
        qs.push({
          id:'q_trend',
          title:'Across a period (left → right), electronegativity tends to…',
          options:['increase','decrease','stay the same'],
          answer:'increase',
          explain:'General trend: effective nuclear charge increases across a period, so atoms tend to pull bonding electrons more strongly.'
        });
      }

      if(!qs.length){
        quiz.innerHTML = '<div class="panel">Practice questions are limited for this element category in v1. Try “Tutor” and use group/period comparisons with neighboring elements.</div>';
        return;
      }

      const wrap = document.createElement('div');
      qs.forEach(q => {
        const card = document.createElement('div');
        card.className = 'q';
        card.innerHTML = `
          <div class="qTitle">${q.title}</div>
          <div class="qOpts">
            ${q.options.map(opt=>`
              <label class="opt">
                <input type="radio" name="${q.id}" value="${opt}" />
                <span>${opt}</span>
              </label>
            `).join('')}
          </div>
          <div class="qFooter">
            <button class="btn" data-check="${q.id}">Check</button>
            <div class="msg" id="msg_${q.id}"></div>
          </div>
        `;

        card.querySelector(`[data-check="${q.id}"]`).addEventListener('click', () => {
          const chosen = card.querySelector(`input[name="${q.id}"]:checked`);
          const msg = card.querySelector(`#msg_${q.id}`);
          if(!chosen){
            msg.textContent = 'Pick an option first.';
            return;
          }
          if(chosen.value === q.answer){
            msg.textContent = `Correct. ${q.explain}`;
          } else {
            msg.textContent = `Not quite. Expected: ${q.answer}. ${q.explain}`;
          }
        });

        wrap.appendChild(card);
      });

      quiz.appendChild(wrap);
    }

    // =============================
    // SELECTION
    // =============================
    function selectElement(Z){
      state.selectedZ = Z;
      renderPT();
      renderFBlocks();
      renderDetail();
    }

    // =============================
    // OVERLAY BUTTONS
    // =============================
    function setOverlay(kind){
      state.overlay = kind;
      document.getElementById('ovCategory').setAttribute('aria-pressed', String(kind === 'category'));
      document.getElementById('ovEN').setAttribute('aria-pressed', String(kind === 'en'));
      document.getElementById('ovAN').setAttribute('aria-pressed', String(kind === 'an'));
      document.getElementById('ovGroup').setAttribute('aria-pressed', String(kind === 'group'));
      renderLegend();
      renderPT();
      renderFBlocks();
      renderDetail();
    }

    // =============================
    // SEARCH
    // =============================
    function setSearch(q){
      state.search = q;
      const hit = findElement(q);
      if(hit && hit.Z){
        state.selectedZ = hit.Z;
      }
      renderPT();
      renderFBlocks();
      renderDetail();
    }

    // =============================
    // MIXTURE LAB: stoichiometry engine
    // =============================

    function mlToL(ml){
      const x = Number(ml);
      if(!Number.isFinite(x)) return 0;
      return x / 1000;
    }

    function moles(M, mL){
      const molarity = Number(M);
      const volL = mlToL(mL);
      if(!Number.isFinite(molarity) || molarity < 0) return 0;
      return molarity * volL;
    }

    function fmt(x, digits=4){
      if(!Number.isFinite(x)) return '0';
      const d = Math.max(0, digits);
      return (Math.round(x * Math.pow(10,d)) / Math.pow(10,d)).toString();
    }

    function clearViz(){
      const viz = document.getElementById('viz');
      const precip = document.getElementById('precip');
      const heat = document.getElementById('heat');
      precip.style.height = '0px';
      precip.style.background = 'rgba(255,255,255,.86)';
      heat.style.background = 'radial-gradient(240px 160px at 50% 60%, rgba(255,170,75,.0), rgba(255,170,75,.0))';

      [...viz.querySelectorAll('.bubble')].forEach(b => b.remove());
    }

    function spawnBubbles(count=18){
      const viz = document.getElementById('viz');
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.className = 'bubble';
        b.style.left = `${Math.random()*95}%`;
        b.style.animationDelay = `${Math.random()*1.2}s`;
        b.style.animationDuration = `${1.8 + Math.random()*1.8}s`;
        b.style.opacity = `${0.35 + Math.random()*0.35}`;
        b.style.transform = `scale(${0.8 + Math.random()*0.6})`;
        viz.appendChild(b);
      }
    }

    function applyVisuals(visuals, extent){
      clearViz();
      const precip = document.getElementById('precip');
      const heat = document.getElementById('heat');

      if(visuals.kind === 'gas'){
        spawnBubbles(Math.round(10 + 24*extent));
      }
      if(visuals.kind === 'precip'){
        const h = 10 + 70*extent;
        precip.style.height = `${h}px`;
        if(visuals.precipColor === 'blue') precip.style.background = 'rgba(120,165,255,.88)';
        if(visuals.precipColor === 'white') precip.style.background = 'rgba(245,245,250,.9)';
      }
      if(visuals.kind === 'heat'){
        heat.style.background = `radial-gradient(240px 160px at 50% 60%, rgba(255,170,75,${0.15+0.35*extent}), rgba(255,170,75,0))`;
      }
      if(visuals.kind === 'color'){
        if(visuals.colorShift === 'blueToGreen'){
          heat.style.background = `radial-gradient(260px 180px at 55% 55%, rgba(120,165,255,${0.20*(1-extent)}), rgba(122,240,166,${0.18*extent}))`;
        }
      }
    }

    function reactantMoles(mode, a, b){
      const m = String(mode || 'solution');
      if(m === 'moles'){
        const x = Number(a);
        if(!Number.isFinite(x) || x < 0) return 0;
        return x;
      }
      return moles(a, b);
    }

    function isPos(x){
      return Number.isFinite(x) && x > 0;
    }

    function numOrNull(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : null;
    }

  function runMixture(){
  const selVal = document.getElementById('rxnSelect').value;
  const rxn = REACTIONS.find(r => r.id === selVal);

  if(!rxn){
    document.getElementById('outcomeBadge').textContent = 'Select a reaction first.';
    document.getElementById('eqn').textContent = 'No reaction selected.';
    document.getElementById('steps').innerHTML =
      '<div class="step"><strong>Setup:</strong> The dropdown has no selected value.</div>';
    document.getElementById('notes').textContent = '';
    clearViz();
    return;
  }

  const modeA = rxn.A.mode || 'solution';
  const modeB = rxn.B.mode || 'solution';

  const a1 = document.getElementById('r1M').value;
  const a2 = document.getElementById('r1V').value;
  const b1 = document.getElementById('r2M').value;
  const b2 = document.getElementById('r2V').value;

  // Validate Reactant A
  if(modeA === 'solution'){
    const M = numOrNull(a1), V = numOrNull(a2);
    if(!isPos(M) || !isPos(V)){
      document.getElementById('outcomeBadge').textContent =
        'Enter positive molarity and volume for Reactant A (or click Example values).';
      document.getElementById('eqn').textContent = rxn.balanced;
      document.getElementById('steps').innerHTML =
        '<div class="step"><strong>Input check:</strong> Reactant A needs both molarity (M) and volume (mL) greater than zero.</div>';
      document.getElementById('notes').textContent = rxn.notes || '';
      clearViz();
      return;
    }
  } else { // moles mode
    const mol = numOrNull(a1);
    if(!isPos(mol)){
      document.getElementById('outcomeBadge').textContent =
        'Enter positive moles for Reactant A (or click Example values).';
      document.getElementById('eqn').textContent = rxn.balanced;
      document.getElementById('steps').innerHTML =
        '<div class="step"><strong>Input check:</strong> Reactant A is treated as a direct amount in moles for this reaction.</div>';
      document.getElementById('notes').textContent = rxn.notes || '';
      clearViz();
      return;
    }
  }

  // Validate Reactant B
  if(modeB === 'solution'){
    const M = numOrNull(b1), V = numOrNull(b2);
    if(!isPos(M) || !isPos(V)){
      document.getElementById('outcomeBadge').textContent =
        'Enter positive molarity and volume for Reactant B (or click Example values).';
      document.getElementById('eqn').textContent = rxn.balanced;
      document.getElementById('steps').innerHTML =
        '<div class="step"><strong>Input check:</strong> Reactant B needs both molarity (M) and volume (mL) greater than zero.</div>';
      document.getElementById('notes').textContent = rxn.notes || '';
      clearViz();
      return;
    }
  } else { // moles mode
    const mol = numOrNull(b1);
    if(!isPos(mol)){
      document.getElementById('outcomeBadge').textContent =
        'Enter positive moles for Reactant B (or click Example values).';
      document.getElementById('eqn').textContent = rxn.balanced;
      document.getElementById('steps').innerHTML =
        '<div class="step"><strong>Input check:</strong> Reactant B is treated as a direct amount in moles for this reaction.</div>';
      document.getElementById('notes').textContent = rxn.notes || '';
      clearViz();
      return;
    }
  }

  const nA = reactantMoles(modeA, a1, a2);
  const nB = reactantMoles(modeB, b1, b2);

  if(nA <= 0 || nB <= 0){
    document.getElementById('outcomeBadge').textContent =
      'One reactant amount is zero, so the model predicts no reaction extent.';
    document.getElementById('eqn').textContent = rxn.balanced;
    document.getElementById('steps').innerHTML =
      '<div class="step"><strong>Extent:</strong> extent = 0 because at least one reactant has 0 moles.</div>';
    document.getElementById('notes').textContent = rxn.notes || '';
    clearViz();
    return;
  }

  const extA = rxn.A.coeff > 0 ? nA / rxn.A.coeff : 0;
  const extB = rxn.B.coeff > 0 ? nB / rxn.B.coeff : 0;
  const extent = Math.min(extA, extB);

  const limiting = (extA < extB) ? 'A' : (extB < extA) ? 'B' : 'none';

  const usedA = rxn.A.coeff * extent;
  const usedB = rxn.B.coeff * extent;
  const leftA = Math.max(0, nA - usedA);
  const leftB = Math.max(0, nB - usedB);

  const vizScale = clamp(extent / 0.05, 0, 1);

  document.getElementById('eqn').textContent = rxn.balanced;
  document.getElementById('outcomeBadge').textContent = `${rxn.type}: ${rxn.visuals.message}`;

  const steps = [];
  steps.push({ title:"Classify", text:`This reaction is treated as: ${rxn.type}. The tutor uses a rule-based model for predictable outcomes.` });

  const inputExplainA = (modeA === 'moles')
    ? `Reactant A is interpreted as a direct amount in moles: n(A) = ${fmt(nA)} mol.`
    : `Reactant A uses n = M × V: n(A) = ${fmt(nA)} mol (V converted from mL to L).`;
  const inputExplainB = (modeB === 'moles')
    ? `Reactant B is interpreted as a direct amount in moles: n(B) = ${fmt(nB)} mol.`
    : `Reactant B uses n = M × V: n(B) = ${fmt(nB)} mol (V converted from mL to L).`;

  steps.push({ title:"Translate inputs into moles", text:`${inputExplainA} ${inputExplainB}` });
  steps.push({ title:"Use coefficients to compare", text:`Compare n(A)/a and n(B)/b: ${fmt(extA)} vs ${fmt(extB)}. The smaller value sets the reaction extent (extent = ${fmt(extent)} mol of reaction).` });

  let limText = 'Neither reactant is limiting in this calculation (perfect stoichiometric match).';
  if(limiting === 'A') limText = 'Reactant A is limiting, so the reaction stops when A is used up.';
  if(limiting === 'B') limText = 'Reactant B is limiting, so the reaction stops when B is used up.';
  steps.push({ title:"Limiting reactant", text: limText });

  steps.push({ title:"Compute amounts consumed and left", text:`Used A = a×extent = ${fmt(usedA)} mol, left A ≈ ${fmt(leftA)} mol. Used B = b×extent = ${fmt(usedB)} mol, left B ≈ ${fmt(leftB)} mol.` });

  const prodCoeffs = rxn.prodCoeffs || {};
  const produced = rxn.products.map(p => {
    const c = (typeof prodCoeffs[p] === 'number') ? prodCoeffs[p] : 1;
    return {p, mol: c * extent};
  });
  steps.push({ title:"Compute products", text:`Predicted products (moles): ${produced.map(x => `${x.p}: ${fmt(x.mol)} mol`).join(' · ')}` });

  steps.push({ title:"Connect to the observable outcome", text:`Observable: ${rxn.visuals.message} (visual scale reflects reaction extent for demonstration).` });

  document.getElementById('notes').textContent = rxn.notes;
  document.getElementById('steps').innerHTML =
    steps.map(s => `<div class="step"><strong>${s.title}:</strong> ${s.text}</div>`).join('');

  applyVisuals(rxn.visuals, vizScale);
}

    function resetMixtureInputs(){
      document.getElementById('r1M').value = '';
      document.getElementById('r1V').value = '';
      document.getElementById('r2M').value = '';
      document.getElementById('r2V').value = '';
      clearViz();
      document.getElementById('outcomeBadge').textContent = 'Choose a reaction and run the mixture.';
      document.getElementById('eqn').textContent = 'Equation will appear here.';
      document.getElementById('steps').innerHTML = '';
      document.getElementById('notes').textContent = '';
      document.getElementById('testStatus').textContent = '';

      // Restore visibility of volume fields according to current reaction
      syncReactantLabels();
    }

function renderReactionSelect(){
  const sel = document.getElementById('rxnSelect');
  sel.innerHTML = REACTIONS.map(r => `<option value="${r.id}">${r.label}</option>`).join('');
  sel.value = REACTIONS[0]?.id || '';     // <-- add this
  syncReactantLabels();
}

    function syncReactantLabels(){
      const rxnId = document.getElementById('rxnSelect').value;
      const rxn = REACTIONS.find(r => r.id === rxnId);
      if(!rxn) return;

      document.getElementById('r1Chip').textContent = `A: ${rxn.A.display} (coeff ${rxn.A.coeff})`;
      document.getElementById('r2Chip').textContent = `B: ${rxn.B.display} (coeff ${rxn.B.coeff})`;

      const r1M = document.getElementById('r1M');
      const r1V = document.getElementById('r1V');
      const r2M = document.getElementById('r2M');
      const r2V = document.getElementById('r2V');

      const modeA = rxn.A.mode || 'solution';
      const modeB = rxn.B.mode || 'solution';

      if(modeA === 'moles'){
        r1M.placeholder = 'Moles (mol)';
        r1V.style.display = 'none';
      } else {
        r1M.placeholder = 'Molarity (M)';
        r1V.placeholder = 'Volume (mL)';
        r1V.style.display = '';
      }

      if(modeB === 'moles'){
        r2M.placeholder = 'Moles (mol)';
        r2V.style.display = 'none';
      } else {
        r2M.placeholder = 'Molarity (M)';
        r2V.placeholder = 'Volume (mL)';
        r2V.style.display = '';
      }
    }

    // =============================
    // TESTS (sanity checks)
    // =============================
    function runTests(){
      const out = document.getElementById('testStatus');
      const results = [];

      function assert(name, cond){
        results.push({name, ok: !!cond});
      }

      // Dataset integrity
      assert('ELEMENTS length is 118', ELEMENTS.length === 118);
      assert('Element #1 is Hydrogen', byZ(1) && byZ(1).sym === 'H');
      assert('Element #8 is Oxygen', byZ(8) && byZ(8).sym === 'O');
      assert('Element #118 is Oganesson', byZ(118) && byZ(118).sym === 'Og');

      // Basic rules
      assert('Valence electrons for Cl (group 17) is 7', valenceElectrons(byZ(17)) === 7);
      assert('Typical ion for Na (group 1) is +1', typicalIon(byZ(11)) === '+1');
      assert('Typical ion for Ne (group 18) is 0', typicalIon(byZ(10)) === '0');

      // Stoichiometry helpers
      assert('moles(1 M, 1000 mL) is 1', Math.abs(moles(1, 1000) - 1) < 1e-12);
      assert('mlToL(250) is 0.25', Math.abs(mlToL(250) - 0.25) < 1e-12);
      assert('reactantMoles(moles, 0.5) is 0.5', Math.abs(reactantMoles('moles', 0.5, 0) - 0.5) < 1e-12);
      assert('reactantMoles(solution, 2M and 500mL) is 1', Math.abs(reactantMoles('solution', 2, 500) - 1) < 1e-12);

      // Reaction library sanity
      assert('REACTIONS length is at least 1', REACTIONS.length >= 1);
      assert('neutralization exists', !!REACTIONS.find(r => r.id === 'neutralization'));

      // Single-replacement modes sanity
      const sr = REACTIONS.find(r => r.id === 'single_replacement');
      assert('single_replacement exists', !!sr);
      if(sr){
        assert('single_replacement A is moles mode', (sr.A.mode || 'solution') === 'moles');
        assert('single_replacement B is solution mode', (sr.B.mode || 'solution') === 'solution');
      }

      // Reaction coefficients sanity
      const rxn = REACTIONS.find(r => r.id === 'precip_cuoh2');
      if(rxn){
        const nA = 0.10; // mol
        const nB = 0.30; // mol
        const extA = nA / rxn.A.coeff;
        const extB = nB / rxn.B.coeff;
        const extent = Math.min(extA, extB);
        assert('CuSO4 + 2 NaOH: extent is limited by A when B is excess', Math.abs(extent - 0.10) < 1e-12);
        assert('CuSO4 + 2 NaOH: used B is 0.20 mol', Math.abs((rxn.B.coeff * extent) - 0.20) < 1e-12);
      } else {
        assert('Reaction precip_cuoh2 exists', false);
      }

      const pass = results.every(r => r.ok);
      const summary = `${pass ? 'All tests passed' : 'Some tests failed'} (${results.filter(r=>r.ok).length}/${results.length})`;

      out.textContent = summary;
      if(!pass){
        console.group('Chemistry Learning Lab tests');
        results.forEach(r => console[r.ok ? 'log' : 'error'](`${r.ok ? 'PASS' : 'FAIL'}: ${r.name}`));
        console.groupEnd();
      }

      return {pass, results};
    }

    // =============================
    // INIT
    // =============================
    function fillExampleValues(){
      const rxn = REACTIONS.find(r => r.id === document.getElementById('rxnSelect').value);
      if(!rxn) return;

      // A simple, always-working set of values.
      // For coefficient 2 on B, give B roughly double the moles.
      const baseM = 1.0;
      const baseV = 50; // mL

      if((rxn.A.mode || 'solution') === 'moles'){
        document.getElementById('r1M').value = '0.05';
        document.getElementById('r1V').value = '';
      } else {
        document.getElementById('r1M').value = String(baseM);
        document.getElementById('r1V').value = String(baseV);
      }

      if((rxn.B.mode || 'solution') === 'moles'){
        const m = 0.05 * (rxn.B.coeff / rxn.A.coeff);
        document.getElementById('r2M').value = String(m);
        document.getElementById('r2V').value = '';
      } else {
        document.getElementById('r2M').value = String(baseM);
        document.getElementById('r2V').value = String(baseV * (rxn.B.coeff / rxn.A.coeff));
      }

      syncReactantLabels();
    }

    function init(){
      // Overlay buttons
      document.getElementById('ovCategory').addEventListener('click', () => setOverlay('category'));
      document.getElementById('ovEN').addEventListener('click', () => setOverlay('en'));
      document.getElementById('ovAN').addEventListener('click', () => setOverlay('an'));
      document.getElementById('ovGroup').addEventListener('click', () => setOverlay('group'));

      // Detail tabs
      document.getElementById('tabBasics').addEventListener('click', () => setDetailTab('basics'));
      document.getElementById('tabTutor').addEventListener('click', () => setDetailTab('tutor'));
      document.getElementById('tabPractice').addEventListener('click', () => setDetailTab('practice'));

      // Search
      const search = document.getElementById('search');
      search.addEventListener('input', (ev) => setSearch(ev.target.value));

      // Mixture lab
      renderReactionSelect();
      document.getElementById('rxnSelect').addEventListener('change', () => {
        syncReactantLabels();
        resetMixtureInputs();
      });
      document.getElementById('exampleBtn').addEventListener('click', () => {
        fillExampleValues();
      });
      document.getElementById('runBtn').addEventListener('click', runMixture);
      document.getElementById('resetBtn').addEventListener('click', resetMixtureInputs);
      document.getElementById('runTestsBtn').addEventListener('click', runTests);

      // Initial render
      renderLegend();
      renderPT();
      renderFBlocks();
      renderDetail();

      // Default selection
      selectElement(8);
      setDetailTab('basics');

      // Auto-run tests in dev if you open with ?tests=1
      if(new URLSearchParams(location.search).get('tests') === '1') runTests();
    }

    init();
  </script>
</body>
</html>
